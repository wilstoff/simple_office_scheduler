@page "/"
@page "/calendar"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject SimpleOfficeScheduler.Services.CalendarUpdateNotifier Notifier
@implements IAsyncDisposable
@rendermode InteractiveServer

<PageTitle>Calendar - Office Scheduler</PageTitle>

<div id="fullcalendar-container"></div>

<EventFormPanel IsVisible="_showCreatePanel"
                IsVisibleChanged="HandleCreatePanelClosed"
                PrefilledStart="_selectedStart"
                PrefilledEnd="_selectedEnd"
                EventId="_editEventId"
                OnEventSaved="HandleEventSaved" />

<EventDetailPanel @bind-IsVisible="_showDetailPanel"
                  EventId="_selectedEventId"
                  OccurrenceId="_selectedOccurrenceId"
                  OnEventChanged="HandleEventChanged"
                  OnEditRequested="HandleEditRequested" />

@code {
    private readonly string _ownerId = Guid.NewGuid().ToString("N");
    private IJSObjectReference? _module;
    private DotNetObjectReference<EventCalendar>? _dotNetRef;
    private IDisposable? _notifierSubscription;

    private bool _showCreatePanel;
    private bool _showDetailPanel;
    private DateTime? _selectedStart;
    private DateTime? _selectedEnd;
    private int? _selectedEventId;
    private int? _selectedOccurrenceId;
    private int? _editEventId;

    protected override void OnInitialized()
    {
        _notifierSubscription = Notifier.Subscribe(() =>
        {
            _ = InvokeAsync(RefetchEvents);
        });
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _module = await JS.InvokeAsync<IJSObjectReference>(
                "import", "/js/fullcalendar-interop.js");
            _dotNetRef = DotNetObjectReference.Create(this);
            await _module.InvokeVoidAsync("initCalendar", _dotNetRef, new
            {
                elementId = "fullcalendar-container",
                eventsUrl = "/api/events/calendar",
                initialView = "timeGridWeek",
                selectable = true,
                selectMirror = true
            }, _ownerId);
        }
    }

    [JSInvokable]
    public Task OnTimeRangeSelected(string start, string end, bool allDay)
    {
        _selectedStart = DateTime.Parse(start, null, System.Globalization.DateTimeStyles.RoundtripKind);
        _selectedEnd = DateTime.Parse(end, null, System.Globalization.DateTimeStyles.RoundtripKind);
        _editEventId = null;
        _showDetailPanel = false;
        _showCreatePanel = true;
        StateHasChanged();
        return Task.CompletedTask;
    }

    [JSInvokable]
    public Task OnEventClicked(string occurrenceIdStr, string eventDataJson)
    {
        // occurrenceIdStr is the calendar feed's "id" field = occurrence ID
        int.TryParse(occurrenceIdStr, out var occurrenceId);
        _selectedOccurrenceId = occurrenceId > 0 ? occurrenceId : null;

        try
        {
            var data = System.Text.Json.JsonDocument.Parse(eventDataJson);
            if (data.RootElement.TryGetProperty("eventId", out var eidProp) && eidProp.TryGetInt32(out var eid))
            {
                _selectedEventId = eid;
            }
        }
        catch
        {
            // Fall back: no event ID available
        }

        _showCreatePanel = false;
        _showDetailPanel = true;
        StateHasChanged();
        return Task.CompletedTask;
    }

    [JSInvokable]
    public Task OnDatesChanged(string start, string end)
    {
        return Task.CompletedTask;
    }

    private async Task HandleEventSaved()
    {
        _showCreatePanel = false;
        _editEventId = null;
        await ClearSelection();
        await RefetchEvents();
    }

    private async Task HandleEventChanged()
    {
        await RefetchEvents();
    }

    private void HandleEditRequested(int eventId)
    {
        _showDetailPanel = false;
        _editEventId = eventId;
        _selectedStart = null;
        _selectedEnd = null;
        _showCreatePanel = true;
    }

    private async Task HandleCreatePanelClosed(bool isVisible)
    {
        _showCreatePanel = isVisible;
        if (!isVisible)
        {
            await ClearSelection();
        }
    }

    private async Task ClearSelection()
    {
        if (_module is not null)
        {
            try
            {
                await _module.InvokeVoidAsync("clearSelection");
            }
            catch (JSDisconnectedException) { }
        }
    }

    private async Task RefetchEvents()
    {
        if (_module is not null)
        {
            try
            {
                await _module.InvokeVoidAsync("refetchEvents");
            }
            catch (JSDisconnectedException) { }
        }
    }

    public async ValueTask DisposeAsync()
    {
        _notifierSubscription?.Dispose();
        if (_module is not null)
        {
            try
            {
                await _module.InvokeVoidAsync("destroyCalendar", _ownerId);
                await _module.DisposeAsync();
            }
            catch (JSDisconnectedException)
            {
                // Circuit already disconnected
            }
        }
        _dotNetRef?.Dispose();
    }
}
