@page "/calendar"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@inject IJSRuntime JS
@inject NavigationManager Navigation
@implements IAsyncDisposable
@rendermode InteractiveServer

<PageTitle>Calendar - Office Scheduler</PageTitle>

<h3>Weekly Calendar</h3>

<div id="fullcalendar-container" style="min-height: 600px;"></div>

@code {
    private IJSObjectReference? _module;
    private DotNetObjectReference<EventCalendar>? _dotNetRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _module = await JS.InvokeAsync<IJSObjectReference>(
                "import", "/js/fullcalendar-interop.js");
            _dotNetRef = DotNetObjectReference.Create(this);
            await _module.InvokeVoidAsync("initCalendar", _dotNetRef, new
            {
                elementId = "fullcalendar-container",
                eventsUrl = "/api/events/calendar",
                initialView = "timeGridWeek"
            });
        }
    }

    [JSInvokable]
    public Task OnEventClicked(string eventId, string url)
    {
        if (!string.IsNullOrEmpty(url))
        {
            Navigation.NavigateTo(url);
        }
        return Task.CompletedTask;
    }

    [JSInvokable]
    public Task OnDatesChanged(string start, string end)
    {
        return Task.CompletedTask;
    }

    public async ValueTask DisposeAsync()
    {
        if (_module is not null)
        {
            try
            {
                await _module.InvokeVoidAsync("destroyCalendar");
                await _module.DisposeAsync();
            }
            catch (JSDisconnectedException)
            {
                // Circuit already disconnected
            }
        }
        _dotNetRef?.Dispose();
    }
}
