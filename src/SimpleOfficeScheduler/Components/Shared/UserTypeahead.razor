@using SimpleOfficeScheduler.Services.Users
@inject IUserSearchService UserSearchService
@rendermode InteractiveServer

<div class="position-relative" @onfocusout="HandleFocusOut">
    <input type="text"
           class="form-control @(SelectedUser is not null ? "border-success" : "")"
           placeholder="@Placeholder"
           value="@_searchText"
           @oninput="OnSearchInput"
           @onfocus="HandleFocus"
           autocomplete="off" />

    @if (SelectedUser is not null)
    {
        <small class="text-success">
            Selected: @SelectedUser.DisplayName (@SelectedUser.Username)
        </small>
    }

    @if (_showDropdown && _results.Any())
    {
        <ul class="list-group position-absolute w-100 shadow-sm"
            style="z-index: 1060; max-height: 200px; overflow-y: auto;">
            @foreach (var user in _results)
            {
                <li class="list-group-item list-group-item-action py-1 px-2"
                    style="cursor: pointer;"
                    @onmousedown="() => SelectUser(user)"
                    @onmousedown:preventDefault>
                    <div>
                        <strong>@user.DisplayName</strong>
                        <small class="text-muted ms-1">(@user.Username)</small>
                        @if (user.IsAdOnly)
                        {
                            <span class="badge bg-info ms-1" style="font-size: 0.65em;">AD</span>
                        }
                    </div>
                    <small class="text-muted">@user.Email</small>
                </li>
            }
        </ul>
    }
    else if (_showDropdown && _searchText.Length >= 2 && !_isSearching)
    {
        <ul class="list-group position-absolute w-100 shadow-sm" style="z-index: 1060;">
            <li class="list-group-item text-muted py-1 px-2">No users found</li>
        </ul>
    }
    else if (_isSearching)
    {
        <ul class="list-group position-absolute w-100 shadow-sm" style="z-index: 1060;">
            <li class="list-group-item text-muted py-1 px-2">
                <span class="spinner-border spinner-border-sm me-1"></span> Searching...
            </li>
        </ul>
    }
</div>

@code {
    [Parameter] public string Placeholder { get; set; } = "Search for a user...";
    [Parameter] public int? ExcludeUserId { get; set; }
    [Parameter] public UserSearchResult? SelectedUser { get; set; }
    [Parameter] public EventCallback<UserSearchResult?> SelectedUserChanged { get; set; }

    private string _searchText = string.Empty;
    private List<UserSearchResult> _results = new();
    private bool _showDropdown;
    private bool _isSearching;
    private CancellationTokenSource? _debounceTokenSource;

    private async Task OnSearchInput(ChangeEventArgs e)
    {
        _searchText = e.Value?.ToString() ?? string.Empty;

        // Clear selection when user types
        if (SelectedUser is not null)
        {
            SelectedUser = null;
            await SelectedUserChanged.InvokeAsync(null);
        }

        // Cancel previous debounce
        _debounceTokenSource?.Cancel();
        _debounceTokenSource = new CancellationTokenSource();
        var token = _debounceTokenSource.Token;

        if (_searchText.Length < 2)
        {
            _results.Clear();
            _showDropdown = false;
            return;
        }

        _isSearching = true;
        StateHasChanged();

        try
        {
            await Task.Delay(300, token);
            if (token.IsCancellationRequested) return;

            _results = await UserSearchService.SearchUsersAsync(_searchText, ExcludeUserId);
            _showDropdown = true;
        }
        catch (TaskCanceledException)
        {
            // Debounce cancelled â€” expected
        }
        finally
        {
            _isSearching = false;
        }
    }

    private async Task SelectUser(UserSearchResult user)
    {
        SelectedUser = user;
        _searchText = user.DisplayName;
        _showDropdown = false;
        _results.Clear();
        await SelectedUserChanged.InvokeAsync(user);
    }

    private void HandleFocus()
    {
        if (_results.Any())
            _showDropdown = true;
    }

    private async Task HandleFocusOut()
    {
        // Small delay to allow @onmousedown to fire before hiding
        await Task.Delay(200);
        _showDropdown = false;
    }
}
